---
title: "Trend"
format: html
editor: visual
---

```{r}
library(readr)
library(tidyverse)
library(lubridate)
library(splines)
library(broom)
library(usmap)
```

## Join

```{r}
Trend <- read_csv("Data/Trend.csv")
X2010trend <- read_csv("Data/2010trend.csv")
Trend_all <- bind_rows(X2010trend, Trend)
```

```{r}
X2010_Sepsis <- read_csv("Data/2010 Sepsis.csv")
X2018Sepsis <- read_csv("Data/2018Sepsis.csv")
X2010_Sepsis <- read_csv("Data/2010 Sepsis.csv") %>%
  mutate(`Crude Rate` = as.character(`Crude Rate`))

X2018Sepsis <- read_csv("Data/2018Sepsis.csv") %>%
  mutate(`Crude Rate` = as.character(`Crude Rate`))
Sepsis <- bind_rows(X2010_Sepsis, X2018Sepsis)
```

```{r}
X2010_renal_s <- read_csv("Data/2010 renal&s.csv")
X2018_renal_s <- read_csv("Data/2018 renal&s.csv")
RenalS <-  bind_rows(X2010_renal_s , X2018_renal_s )
```
## Trend All
```{r}
glimpse(Trend_all)
```
```{r}
trend_plot_df <- Trend_all %>%
  mutate(
    crude_rate = parse_number(`Crude Rate`),   # "Unreliable" -> NA
    aa_rate    = parse_number(`Age Adjusted Rate`),  # if present; otherwise NA
    cause      = `Multiple Cause of death`
  )
```
```{r}
top_causes <- trend_plot_df %>%
  group_by(cause) %>%
  summarise(total_deaths = sum(Deaths, na.rm = TRUE), .groups = "drop") %>%
  slice_max(total_deaths, n = 6) %>%
  pull(cause)

p1 <- trend_plot_df %>%
  filter(cause %in% top_causes) %>%
  ggplot(aes(x = Year, y = crude_rate, group = cause)) +
  geom_line(linewidth = 1) +
  facet_wrap(~ cause, scales = "free_y") +
  labs(
    x = NULL,
    y = "Crude rate (per 100,000)",
    title = "Trends in crude death rates by cause (top 6 by deaths)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold")
  )

p1

```
```{r}
renal_by_group <- Trend_all %>%
  mutate(
    renal_group = case_when(
      str_detect(`Multiple Cause of death Code`, "^N17") ~ "AKI (N17)",
      str_detect(`Multiple Cause of death Code`, "^N18") ~ "CKD (N18)",
      `Multiple Cause of death Code` == "N19"            ~ "Unspecified renal failure (N19)",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(renal_group)) %>%
  group_by(Year, renal_group) %>%
  summarise(
    deaths = sum(Deaths, na.rm = TRUE),
    population = max(Population, na.rm = TRUE),
    crude_rate = deaths / population * 1e5,
    .groups = "drop"
  ) %>%
  arrange(Year, renal_group)

renal_by_group

```
```{r}
renal_plot <- ggplot(renal_by_group, aes(x = Year, y = crude_rate, color = renal_group)) +
  # COVID shading (behind data)
  annotate(
    "rect",
    xmin = 2020, xmax = 2021.99,
    ymin = -Inf, ymax = Inf,
    fill = "grey70", alpha = 0.12
  ) +
  
  # Trend lines
  geom_line(linewidth = 1.3) +
  
  # Axis formatting
  scale_x_continuous(
    breaks = seq(min(renal_by_group$Year),
                 max(renal_by_group$Year), by = 2)
  ) +
  
  scale_color_manual(
    values = c(
      "AKI (N17)" = "#1b9e77",
      "CKD (N18)" = "#7570b3",
      "Unspecified renal failure (N19)" = "#d95f02"
    )
  ) +
  
  labs(
    x = NULL,
    y = "Crude mortality rate (per 100,000 population)",
    color = NULL,
    title = "Trends in renal failure–related mortality in the United States",
    subtitle = "Acute kidney injury (N17), chronic kidney disease (N18), and unspecified renal failure (N19)\nShaded region indicates the COVID-19 period (2020–2021)"
  ) +
  
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text = element_text(color = "black"),
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "top",
    legend.text = element_text(size = 11)
  )
```
```{r}
latest_year <- max(renal_by_group$Year, na.rm = TRUE)

crude_rate_table <- bind_rows(
  # 2010 baseline
  renal_by_group %>%
    filter(Year == 2010) %>%
    transmute(renal_group, period = "2010 (Baseline)", crude_rate),

  # 2019 pre-COVID
  renal_by_group %>%
    filter(Year == 2019) %>%
    transmute(renal_group, period = "2019 (Pre-COVID)", crude_rate),

  # COVID peak = max of 2020–2021 (per renal_group)
  renal_by_group %>%
    filter(Year %in% c(2020, 2021)) %>%
    group_by(renal_group) %>%
    summarise(crude_rate = max(crude_rate, na.rm = TRUE), .groups = "drop") %>%
    mutate(period = "COVID peak (2020–2021)") %>%
    select(renal_group, period, crude_rate),

  # Latest year
  renal_by_group %>%
    filter(Year == latest_year) %>%
    transmute(renal_group, period = paste0(latest_year, " (Latest)"), crude_rate)
) %>%
  mutate(crude_rate = round(crude_rate, 1)) %>%
  pivot_wider(names_from = period, values_from = crude_rate) %>%
  arrange(factor(
    renal_group,
    levels = c("AKI (N17)", "CKD (N18)", "Unspecified renal failure (N19)")
  ))

crude_rate_table %>%
  kable(
    caption = "Key crude mortality rates by renal failure ICD group (per 100,000)",
    align = "lcccc"
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "condensed"))
```




## Sepsis

```{r}
glimpse(Sepsis)
```
```{r}
sepsis_clean <- Sepsis %>%
  filter(
    !is.na(`Multiple Cause of death Code`),     # drop Total rows
    str_detect(`Multiple Cause of death Code`, "^A4[01]")  # A40–A41 only
  ) %>%
  mutate(
    crude_rate = parse_number(`Crude Rate`)
  )
```
```{r}
sepsis_trend <- sepsis_clean %>%
  group_by(Year) %>%
  summarise(
    deaths = sum(Deaths, na.rm = TRUE),
    population = max(Population, na.rm = TRUE),
    crude_rate = deaths / population * 1e5,
    .groups = "drop"
  ) %>%
  arrange(Year)

```


```{r}
library(ggplot2)

sepsis_plot <- ggplot(sepsis_trend, aes(x = Year, y = crude_rate)) +
  annotate(
    "rect",
    xmin = 2020, xmax = 2021.99,
    ymin = -Inf, ymax = Inf,
    fill = "grey70", alpha = 0.12
  ) +
  geom_line(linewidth = 1.3, color = "#1b9e77") +
  labs(
    x = NULL,
    y = "Crude mortality rate (per 100,000 population)",
    title = "Trends in sepsis-related mortality in the United States",
    subtitle = "Based on ICD-10 codes A40–A41; shaded area indicates COVID-19 period (2020–2021)"
  ) +
  scale_x_continuous(
    breaks = seq(min(sepsis_trend$Year),
                 max(sepsis_trend$Year), by = 2)
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text = element_text(color = "black"),
    plot.title = element_text(face = "bold", size = 14)
  )

```
## Renal & Sepsis

```{r}
glimpse(RenalS)
```

```{r}

renal_sepsis_clean <- RenalS %>%
  filter(
    !is.na(`Multiple Cause of death Code`),
    is.na(Notes) | Notes != "Total"   # <-- key fix
  ) %>%
  mutate(
    code = str_trim(`Multiple Cause of death Code`),
    group = case_when(
      str_detect(code, "^A4[01]") ~ "Sepsis (A40–A41)",
      str_detect(code, "^N17")    ~ "AKI (N17)",
      str_detect(code, "^N18")    ~ "CKD (N18)",
      code == "N19"               ~ "Unspecified renal failure (N19)",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(group))
```

```{r}
renal_sepsis_trend <- renal_sepsis_clean %>%
  group_by(Year, group) %>%
  summarise(
    deaths = sum(Deaths, na.rm = TRUE),
    population = max(Population, na.rm = TRUE),
    crude_rate = deaths / population * 1e5,
    .groups = "drop"
  ) %>%
  arrange(Year, group)

```
```{r}

yr_min <- min(renal_sepsis_trend$Year, na.rm = TRUE)
yr_max <- max(renal_sepsis_trend$Year, na.rm = TRUE)

renal_sepsis_plot <- ggplot(renal_sepsis_trend, aes(x = Year, y = crude_rate, color = group)) +
  annotate(
    "rect",
    xmin = 2020, xmax = 2021.99,
    ymin = -Inf, ymax = Inf,
    fill = "grey70", alpha = 0.12
  ) +
  geom_line(linewidth = 1.3) +
  scale_x_continuous(breaks = seq(yr_min, yr_max, by = 2)) +
  scale_color_manual(
    values = c(
      "AKI (N17)" = "#1b9e77",
      "CKD (N18)" = "#7570b3",
      "Unspecified renal failure (N19)" = "#d95f02",
      "Sepsis (A40–A41)" = "#666666"
    )
  ) +
  labs(
    x = NULL,
    y = "Crude mortality rate (per 100,000 population)",
    color = NULL,
    title = "Trends in renal failure and sepsis–related mortality in the United States",
    subtitle = "AKI (N17), CKD (N18), unspecified renal failure (N19), and sepsis (A40–A41)\nShaded region indicates the COVID-19 period (2020–2021)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text = element_text(color = "black"),
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "top"
  )


```
## Covid
```{r}
covid <- read_csv("Data/covid.csv")
glimpse(covid )
```
```{r}
covid_clean <- covid %>%
  filter(!is.na(`Multiple Cause of death Code`)) %>%
  mutate(
    Year = as.numeric(Year),
    code = str_trim(`Multiple Cause of death Code`),
    group = case_when(
      str_detect(code, "^N17") ~ "AKI (N17)",
      str_detect(code, "^N18") ~ "CKD (N18)",
      code == "N19"            ~ "Unspecified renal failure (N19)",
      code == "U07.1"          ~ "COVID-19 (U07.1)",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(group))
```

```{r}
covid_trend <- covid_clean %>%
  group_by(Year, group) %>%
  summarise(
    deaths = sum(Deaths, na.rm = TRUE),
    population = max(Population, na.rm = TRUE),
    crude_rate = deaths / population * 1e5,
    .groups = "drop"
  ) %>%
  arrange(Year, group)
```

```{r}

yr_min <- min(covid_trend$Year, na.rm = TRUE)
yr_max <- max(covid_trend$Year, na.rm = TRUE)

covid_plot <- ggplot(covid_trend, aes(x = Year, y = crude_rate, color = group)) +
  geom_line(linewidth = 1.3) +
  
  scale_color_manual(
    values = c(
      "AKI (N17)" = "#1b9e77",
      "CKD (N18)" = "#7570b3",
      "Unspecified renal failure (N19)" = "#d95f02",
      "COVID-19 (U07.1)" = "#4d4d4d"
    )
  ) +
  
  scale_x_continuous(breaks = seq(yr_min, yr_max, by = 1)) +
  
  labs(
    x = NULL,
    y = "Crude mortality rate (per 100,000 population)",
    color = NULL,
    title = "Trends in renal failure and COVID-19–related mortality",
    subtitle = "United States, 2020–2022+; based on ICD-10 multiple cause of death codes"
  ) +
  
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text = element_text(color = "black"),
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "top"
  )

```

```{r}
renal_key <- bind_rows(
  renal_by_group %>%
    filter(Year == 2019) %>%
    mutate(period = "2019 (Pre-COVID)"),

  renal_by_group %>%
    filter(Year %in% c(2020, 2021)) %>%
    group_by(renal_group) %>%
    slice_max(crude_rate, n = 1) %>%
    ungroup() %>%
    mutate(period = "COVID peak (2020–2021)"),

  renal_by_group %>%
    filter(Year == max(Year)) %>%
    mutate(period = "Latest year")
) %>%
  select(Group = renal_group, period, crude_rate) %>%
  mutate(crude_rate = round(crude_rate, 1))

```
```{r}
sepsis_key <- bind_rows(
  sepsis_trend %>%
    filter(Year == 2019) %>%
    mutate(period = "2019 (Pre-COVID)"),

  sepsis_trend %>%
    filter(Year %in% c(2020, 2021)) %>%
    slice_max(crude_rate, n = 1) %>%
    mutate(period = "COVID peak (2020–2021)"),

  sepsis_trend %>%
    filter(Year == max(Year)) %>%
    mutate(period = "Latest year")
) %>%
  transmute(
    Group = "Sepsis (A40–A41)",
    period,
    crude_rate = round(crude_rate, 1)
  )


```
```{r}
renal_sepsis_key <- bind_rows(
  renal_sepsis_trend %>%
    filter(Year == 2019) %>%
    mutate(period = "2019 (Pre-COVID)"),

  renal_sepsis_trend %>%
    filter(Year %in% c(2020, 2021)) %>%
    group_by(group) %>%
    slice_max(crude_rate, n = 1) %>%
    ungroup() %>%
    mutate(period = "COVID peak (2020–2021)"),

  renal_sepsis_trend %>%
    filter(Year == max(Year)) %>%
    mutate(period = "Latest year")
) %>%
  select(Group = group, period, crude_rate) %>%
  mutate(crude_rate = round(crude_rate, 1))

```


```{r}
renal_covid_key <- bind_rows(
  covid_trend %>%
    filter(Year == min(Year)) %>%
    mutate(period = "Baseline"),

  covid_trend %>%
    group_by(group) %>%
    slice_max(crude_rate, n = 1) %>%
    ungroup() %>%
    mutate(period = "Peak"),

  covid_trend %>%
    filter(Year == max(Year)) %>%
    mutate(period = "Latest year")
) %>%
  select(Group = group, period, crude_rate) %>%
  mutate(crude_rate = round(crude_rate, 1))

```


```{r}
important_numbers <- bind_rows(
  mutate(renal_key, Analysis = "Renal only"),
  mutate(sepsis_key, Analysis = "Sepsis"),
  mutate(renal_sepsis_key, Analysis = "Renal + Sepsis"),
  mutate(renal_covid_key, Analysis = "Renal + COVID")
)

important_numbers

```

```{r}
library(writexl)

write_xlsx(
  important_numbers,
  "important_numbers_trends.xlsx"
)

```

```{r}
dir.create("figures", showWarnings = FALSE)

dpi_pub <- 600   # journal standard
width  <- 7      # inches
height <- 5
```

```{r}
ggsave(
  filename = "figures/fig_renal_trend.tiff",
  plot = renal_plot,          # <-- your renal-only ggplot object
  device = "tiff",
  dpi = dpi_pub,
  width = width,
  height = height,
  units = "in",
  compression = "lzw"
)

```

```{r}
ggsave(
  filename = "figures/fig_sepsis_trend.tiff",
  plot = sepsis_plot,
  device = "tiff",
  dpi = dpi_pub,
  width = width,
  height = height,
  units = "in",
  compression = "lzw"
)

```

```{r}
ggsave(
  filename = "figures/fig_renal_sepsis_trend.tiff",
  plot = renal_sepsis_plot,
  device = "tiff",
  dpi = dpi_pub,
  width = width,
  height = height,
  units = "in",
  compression = "lzw"
)

```

```{r}
ggsave(
  filename = "figures/fig_renal_covid_trend.tiff",
  plot = covid_plot,
  device = "tiff",
  dpi = dpi_pub,
  width = width,
  height = height,
  units = "in",
  compression = "lzw"
)
```

```{r}
library(dplyr)

facet_trend <- bind_rows(
  renal_by_group %>%
    transmute(
      Year,
      Group = renal_group,
      crude_rate,
      Panel = "A. Renal only (AKI / CKD / N19)"
    ),

  sepsis_trend %>%
    transmute(
      Year,
      Group = "Sepsis (A40–A41)",
      crude_rate,
      Panel = "B. Sepsis"
    ),

  renal_sepsis_trend %>%
    transmute(
      Year,
      Group = group,
      crude_rate,
      Panel = "C. Renal + Sepsis"
    ),

  covid_trend %>%
    transmute(
      Year,
      Group = group,
      crude_rate,
      Panel = "D. Renal + COVID"
    )
)

```

```{r}
scale_color_manual(
  values = c(
    "AKI (N17)" = "#1b9e77",
    "CKD (N18)" = "#7570b3",
    "Unspecified renal failure (N19)" = "#d95f02",
    "Sepsis (A40–A41)" = "#666666",   # solid gray
    "COVID-19 (U07.1)" = "#1f78b4"    # solid blue
  )
)


facet_plot <- ggplot(
  facet_trend,
  aes(x = Year, y = crude_rate, color = Group)
) +
  annotate(
    "rect",
    xmin = 2020, xmax = 2021.99,
    ymin = -Inf, ymax = Inf,
    fill = "grey70", alpha = 0.12
  ) +
  geom_line(linewidth = 1.2) +
  facet_wrap(~ Panel, scales = "free_y", ncol = 2) +
  scale_color_manual(
    values = c(
      "AKI (N17)" = "#1b9e77",
      "CKD (N18)" = "#7570b3",
      "Unspecified renal failure (N19)" = "#d95f02",
      "Sepsis (A40–A41)" = "#666666",
      "COVID-19 (U07.1)" = "#1f78b4"
    )
  ) +
  labs(
    x = NULL,
    y = "Crude mortality rate (per 100,000)",
    color = NULL,
    title = "Trends in renal failure, sepsis, and COVID-19–related mortality",
    subtitle = "United States; shaded area indicates the COVID-19 period (2020–2021)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text = element_text(color = "black"),
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "bottom"
  )


facet_plot

```
```{r}
ggsave(
  filename = "figures/fig_trends_facet.jpg",
  plot = facet_plot,
  device = "jpeg",
  dpi = 600,
  width = 12,
  height = 8,
  units = "in",
  quality = 100
)

```


