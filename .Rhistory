writeData(wb, "ARF_period_summary", arf_tbl$publication_table)
addWorksheet(wb, "Sepsis_period_summary")
writeData(wb, "Sepsis_period_summary", sepsis_tbl$publication_table)
addWorksheet(wb, "ARF_Sepsis_period_summary")
writeData(wb, "ARF_Sepsis_period_summary", renal_sepsis_tbl$publication_table)
addWorksheet(wb, "Deaths_by_age")
writeData(wb, "Deaths_by_age", deaths_age_table_pretty)
library(dplyr)
library(tidyr)
add_age3 <- function(df) {
df %>%
mutate(
age3 = case_when(
`Ten-Year Age Groups Code` %in% c("25-34", "35-44") ~ "25_44",
`Ten-Year Age Groups Code` %in% c("45-54", "55-64") ~ "45_64",
`Ten-Year Age Groups Code` %in% c("65-74", "75-84", "85+") ~ "65_plus",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(age3))
}
# ---- Helper: Year x age3 -> deaths & crude rate (adds Total row) ----
year_age_deaths_rates <- function(df, prefix) {
by_year_age <- df %>%
filter(
is.na(Notes) | Notes != "Total",
Year >= 2010, Year <= 2025
) %>%
add_age3() %>%
group_by(Year, age3) %>%
summarise(
deaths = sum(Deaths, na.rm = TRUE),
pop    = sum(Population, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(rate = ifelse(pop > 0, (deaths / pop) * 1e5, NA_real_)) %>%
mutate(Year = as.character(Year)) %>%
complete(
Year = as.character(2010:2025),
age3 = c("25_44", "45_64", "65_plus"),
fill = list(deaths = 0, pop = 0, rate = NA_real_)
)
# Add Total row (sum deaths & pop across years within each age bin; recompute rate)
total_rows <- by_year_age %>%
group_by(age3) %>%
summarise(
Year = "Total",
deaths = sum(deaths, na.rm = TRUE),
pop    = sum(pop, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(rate = ifelse(pop > 0, (deaths / pop) * 1e5, NA_real_))
by_year_age <- bind_rows(by_year_age, total_rows)
deaths_wide <- by_year_age %>%
select(Year, age3, deaths) %>%
pivot_wider(names_from = age3, values_from = deaths, values_fill = 0) %>%
rename(
!!paste0(prefix, "_deaths_25_44")  := `25_44`,
!!paste0(prefix, "_deaths_45_64")  := `45_64`,
!!paste0(prefix, "_deaths_65_plus"):= `65_plus`
)
rates_wide <- by_year_age %>%
select(Year, age3, rate) %>%
pivot_wider(names_from = age3, values_from = rate) %>%
rename(
!!paste0(prefix, "_rate_25_44")   := `25_44`,
!!paste0(prefix, "_rate_45_64")   := `45_64`,
!!paste0(prefix, "_rate_65_plus") := `65_plus`
)
list(deaths = deaths_wide, rates = rates_wide)
}
# ---- Build for the 3 datasets ----
arf    <- year_age_deaths_rates(N17,    "ARF")
sepsis <- year_age_deaths_rates(A40,    "Sepsis")
both   <- year_age_deaths_rates(N17A40, "ARF_Sepsis")
# ---- Combine into one deaths table ----
deaths_table_age <- arf$deaths %>%
full_join(sepsis$deaths, by = "Year") %>%
full_join(both$deaths,   by = "Year") %>%
mutate(Year = factor(Year, levels = c(as.character(2010:2025), "Total"))) %>%
arrange(Year)
# ---- Combine into one crude-rate table ----
rate_table_age <- arf$rates %>%
full_join(sepsis$rates, by = "Year") %>%
full_join(both$rates,   by = "Year") %>%
mutate(Year = factor(Year, levels = c(as.character(2010:2025), "Total"))) %>%
arrange(Year) %>%
# Optional: round rates nicely
mutate(across(where(is.numeric), ~ round(.x, 2)))
deaths_table_age
rate_table_age
year_sex_deaths_rates <- function(df, prefix) {
by_year_sex <- df %>%
filter(
is.na(Notes) | Notes != "Total",
Year >= 2010, Year <= 2025
) %>%
group_by(Year, Sex) %>%
summarise(
deaths = sum(Deaths, na.rm = TRUE),
pop    = sum(Population, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(rate = ifelse(pop > 0, (deaths / pop) * 1e5, NA_real_)) %>%
mutate(Year = as.character(Year)) %>%
complete(
Year = as.character(2010:2025),
Sex = c("Male", "Female"),
fill = list(deaths = 0, pop = 0, rate = NA_real_)
)
# add "Overall" per year
overall_year <- by_year_sex %>%
group_by(Year) %>%
summarise(
Sex = "Overall",
deaths = sum(deaths, na.rm = TRUE),
pop    = sum(pop, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(rate = ifelse(pop > 0, (deaths / pop) * 1e5, NA_real_))
by_year_sex2 <- bind_rows(by_year_sex, overall_year)
# add Total row (sum across years within each Sex; recompute rate)
total_row <- by_year_sex2 %>%
group_by(Sex) %>%
summarise(
Year = "Total",
deaths = sum(deaths, na.rm = TRUE),
pop    = sum(pop, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(rate = ifelse(pop > 0, (deaths / pop) * 1e5, NA_real_))
by_year_sex2 <- bind_rows(by_year_sex2, total_row)
deaths_wide <- by_year_sex2 %>%
select(Year, Sex, deaths) %>%
pivot_wider(names_from = Sex, values_from = deaths, values_fill = 0) %>%
rename(
!!paste0(prefix, "_deaths_Overall") := Overall,
!!paste0(prefix, "_deaths_Male")    := Male,
!!paste0(prefix, "_deaths_Female")  := Female
)
rates_wide <- by_year_sex2 %>%
select(Year, Sex, rate) %>%
pivot_wider(names_from = Sex, values_from = rate) %>%
rename(
!!paste0(prefix, "_rate_Overall") := Overall,
!!paste0(prefix, "_rate_Male")    := Male,
!!paste0(prefix, "_rate_Female")  := Female
)
list(deaths = deaths_wide, rates = rates_wide)
}
# ---- build for three datasets ----
arf    <- year_sex_deaths_rates(N17,    "ARF")
sepsis <- year_sex_deaths_rates(A40,    "Sepsis")
both   <- year_sex_deaths_rates(N17A40, "ARF_Sepsis")
# ---- deaths table (Year + 9 columns) ----
deaths_table_sex <- arf$deaths %>%
full_join(sepsis$deaths, by = "Year") %>%
full_join(both$deaths,   by = "Year") %>%
mutate(Year = factor(Year, levels = c(as.character(2010:2025), "Total"))) %>%
arrange(Year)
# ---- crude rate table (same structure; rounded) ----
rate_table_sex <- arf$rates %>%
full_join(sepsis$rates, by = "Year") %>%
full_join(both$rates,   by = "Year") %>%
mutate(Year = factor(Year, levels = c(as.character(2010:2025), "Total"))) %>%
arrange(Year) %>%
mutate(across(where(is.numeric), ~ round(.x, 2)))
deaths_table_sex
rate_table_sex
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "ARF_period_summary")
writeData(wb, "ARF_period_summary", arf_tbl$publication_table)
addWorksheet(wb, "Sepsis_period_summary")
writeData(wb, "Sepsis_period_summary", sepsis_tbl$publication_table)
addWorksheet(wb, "ARF_Sepsis_period_summary")
writeData(wb, "ARF_Sepsis_period_summary", renal_sepsis_tbl$publication_table)
addWorksheet(wb, "Deaths_by_age")
writeData(wb, "Deaths_by_age", deaths_age_table_pretty)
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "ARF_period_summary")
writeData(wb, "ARF_period_summary", arf_tbl$publication_table)
addWorksheet(wb, "Sepsis_period_summary")
writeData(wb, "Sepsis_period_summary", sepsis_tbl$publication_table)
addWorksheet(wb, "ARF_Sepsis_period_summary")
writeData(wb, "ARF_Sepsis_period_summary", renal_sepsis_tbl$publication_table)
addWorksheet(wb, "Deaths_by_age")
writeData(wb, "Deaths_by_age", deaths_table_age)
addWorksheet(wb, "Rate_by_age")
writeData(wb, "Rate_by_age", rate_table_age)
addWorksheet(wb, "Deaths_by_sex")
writeData(wb, "Deaths_by_sex", deaths_table_sex)
addWorksheet(wb, "Crude_rate_by_sex")
writeData(wb, "Crude_rate_by_sex", rate_table_sex)
addWorksheet(wb, "ARF_Sepsis_overlap_rates")
writeData(wb, "ARF_Sepsis_overlap_rates", overlap_table)
saveWorkbook(
wb,
file = "Supplementary_Tables_ARF_Sepsis_US_2010_2025.xlsx",
overwrite = TRUE
)
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "ARF_year")
writeData(wb, "ARF_year_summary", table_renal_year)
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "ARF_year")
writeData(wb, "table_renal_year", table_renal_year)
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "ARF_year")
writeData(wb, "ARF_year", table_renal_year)
addWorksheet(wb, "sepsis_year")
writeData(wb, "sepsis_year", table_sepsis_year)
addWorksheet(wb, "ARF_sepsis_year")
writeData(wb, "ARF_sepsis_year", table_renal_sepsis_year)
addWorksheet(wb, "ARF_period_summary")
writeData(wb, "ARF_period_summary", table_ARF_period_wide)
addWorksheet(wb, "Sepsis_period_summary")
writeData(wb, "Sepsis_period_summary", sepsis_tbl$publication_table)
addWorksheet(wb, "ARF_Sepsis_period_summary")
writeData(wb, "ARF_Sepsis_period_summary", renal_sepsis_tbl$publication_table)
addWorksheet(wb, "Deaths_by_age")
writeData(wb, "Deaths_by_age", deaths_table_age)
addWorksheet(wb, "Rate_by_age")
writeData(wb, "Rate_by_age", rate_table_age)
addWorksheet(wb, "Deaths_by_sex")
writeData(wb, "Deaths_by_sex", deaths_table_sex)
addWorksheet(wb, "Crude_rate_by_sex")
writeData(wb, "Crude_rate_by_sex", rate_table_sex)
addWorksheet(wb, "ARF_Sepsis_overlap_rates")
writeData(wb, "ARF_Sepsis_overlap_rates", overlap_table)
saveWorkbook(
wb,
file = "Supplementary_Tables_ARF_Sepsis_US_2010_2025.xlsx",
overwrite = TRUE
)
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "ARF_year")
writeData(wb, "ARF_year", table_renal_year)
addWorksheet(wb, "sepsis_year")
writeData(wb, "sepsis_year", table_sepsis_year)
addWorksheet(wb, "ARF_sepsis_year")
writeData(wb, "ARF_sepsis_year", table_renal_sepsis_year)
addWorksheet(wb, "ARF_period_summary")
writeData(wb, "ARF_period_summary", arf_tbl$publication_table)
addWorksheet(wb, "Sepsis_period_summary")
writeData(wb, "Sepsis_period_summary", sepsis_tbl$publication_table)
addWorksheet(wb, "ARF_Sepsis_period_summary")
writeData(wb, "ARF_Sepsis_period_summary", renal_sepsis_tbl$publication_table)
addWorksheet(wb, "Deaths_by_age")
writeData(wb, "Deaths_by_age", deaths_table_age)
addWorksheet(wb, "Rate_by_age")
writeData(wb, "Rate_by_age", rate_table_age)
addWorksheet(wb, "Deaths_by_sex")
writeData(wb, "Deaths_by_sex", deaths_table_sex)
addWorksheet(wb, "Crude_rate_by_sex")
writeData(wb, "Crude_rate_by_sex", rate_table_sex)
addWorksheet(wb, "ARF_Sepsis_overlap_rates")
writeData(wb, "ARF_Sepsis_overlap_rates", overlap_table)
saveWorkbook(
wb,
file = "Supplementary_Tables_ARF_Sepsis_US_2010_2025.xlsx",
overwrite = TRUE
)
library(scales)
make_period_table <- function(df,
outcome_name = "ARF-related deaths",
year_min = 2010,
year_max = 2025,
subchapter_filter = NULL) {
# ---- periods in time order ----
period_map <- tibble::tibble(
period_id = 1:4,
period = c("Pre-pandemic (2010–2019)",
"Pandemic (2020–2022)",
"Transition (2023)",
"Post-pandemic (2024–2025)"),
year_start = c(2010, 2020, 2023, 2024),
year_end   = c(2019, 2022, 2023, 2025)
) %>%
mutate(n_years = year_end - year_start + 1)
add_period <- function(x) {
x %>%
left_join(period_map, join_by(Year >= year_start, Year <= year_end)) %>%
filter(!is.na(period))
}
annual_rate <- function(deaths, pop, n_years) {
ifelse(pop > 0, (deaths / pop) * 1e5 * (1 / n_years), NA_real_)
}
# ---- prep: filter + race + age ----
x <- df %>%
filter(
is.na(Notes) | Notes != "Total",
Year >= year_min, Year <= year_max
)
if (!is.null(subchapter_filter)) {
x <- x %>% filter(`MCD - ICD Sub-Chapter` %in% subchapter_filter)
}
x <- x %>%
mutate(
race_source = coalesce(`Single Race 6`, Race),
# Race rules (as requested):
# - "Asian or Pacific Islander" -> Asian
# - NHOPI is its own category
# - drop not available (handled by NA then filter)
race_unified = case_when(
race_source == "American Indian or Alaska Native" ~ "American Indian or Alaska Native",
race_source %in% c("Asian", "Asian or Pacific Islander") ~ "Asian",
race_source == "Native Hawaiian or Other Pacific Islander" ~ "Native Hawaiian or Other Pacific Islander",
race_source == "Black or African American" ~ "Black or African American",
race_source == "White" ~ "White",
race_source == "More than one race" ~ "More than one race",
TRUE ~ NA_character_
),
age_cat = case_when(
`Ten-Year Age Groups Code` %in% c("25-34", "35-44") ~ "Age 25–44",
`Ten-Year Age Groups Code` %in% c("45-54", "55-64") ~ "Age 45–64",
`Ten-Year Age Groups Code` %in% c("65-74", "75-84", "85+") ~ "Age ≥65",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(race_unified)) %>%   # drops "Not available"
add_period()
# ---- period totals ----
period_totals <- x %>%
group_by(period_id, period, n_years) %>%
summarise(
deaths = sum(Deaths, na.rm = TRUE),
population = sum(Population, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(crude_annual = annual_rate(deaths, population, n_years))
# ---- sex rates ----
period_sex <- x %>%
group_by(period_id, period, n_years, Sex) %>%
summarise(
deaths = sum(Deaths, na.rm = TRUE),
population = sum(Population, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(rate = annual_rate(deaths, population, n_years)) %>%
select(period_id, period, Sex, rate) %>%
pivot_wider(names_from = Sex, values_from = rate) %>%
rename(Male = Male, Female = Female)
# ---- age rates ----
period_age <- x %>%
filter(!is.na(age_cat)) %>%
group_by(period_id, period, n_years, age_cat) %>%
summarise(
deaths = sum(Deaths, na.rm = TRUE),
population = sum(Population, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(rate = annual_rate(deaths, population, n_years)) %>%
select(period_id, period, age_cat, rate) %>%
pivot_wider(names_from = age_cat, values_from = rate)
# ---- race rates ----
period_race <- x %>%
group_by(period_id, period, n_years, race_unified) %>%
summarise(
deaths = sum(Deaths, na.rm = TRUE),
population = sum(Population, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(rate = annual_rate(deaths, population, n_years)) %>%
select(period_id, period, race_unified, rate) %>%
pivot_wider(names_from = race_unified, values_from = rate)
# ---- assemble (period rows) ----
period_table <- period_totals %>%
left_join(period_sex,  by = c("period_id", "period")) %>%
left_join(period_age,  by = c("period_id", "period")) %>%
left_join(period_race, by = c("period_id", "period")) %>%
arrange(period_id) %>%
transmute(
period_id, period,
`Total deaths, n` = deaths,
`Population` = population,
`Crude mortality rate, annual (/100,000)` = crude_annual,
`Male, annual (/100,000)` = Male,
`Female, annual (/100,000)` = Female,
`Age ≥65, annual (/100,000)` = `Age ≥65`,
`Age 45–64, annual (/100,000)` = `Age 45–64`,
`Age 25–44, annual (/100,000)` = `Age 25–44`,
`American Indian or Alaska Native, annual (/100,000)` = `American Indian or Alaska Native`,
`Asian, annual (/100,000)` = Asian,
`Native Hawaiian or Other Pacific Islander, annual (/100,000)` = `Native Hawaiian or Other Pacific Islander`,
`Black or African American, annual (/100,000)` = `Black or African American`,
`White, annual (/100,000)` = White,
`More than one race, annual (/100,000)` = `More than one race`
)
# ---- publication formatting (no scientific notation; commas; 2 decimals) ----
pub <- period_table %>%
select(-period_id) %>%
pivot_longer(cols = -period, names_to = "Metric", values_to = "Value") %>%
mutate(
Value = ifelse(
Metric %in% c("Total deaths, n", "Population"),
formatC(round(Value, 0), format = "f", big.mark = ",", digits = 0),
formatC(round(Value, 2), format = "f", big.mark = ",", digits = 2)
)
) %>%
mutate(
Metric = factor(Metric, levels = c(
"Total deaths, n",
"Population",
"Crude mortality rate, annual (/100,000)",
"Male, annual (/100,000)",
"Female, annual (/100,000)",
"Age ≥65, annual (/100,000)",
"Age 45–64, annual (/100,000)",
"Age 25–44, annual (/100,000)",
"American Indian or Alaska Native, annual (/100,000)",
"Asian, annual (/100,000)",
"Native Hawaiian or Other Pacific Islander, annual (/100,000)",
"Black or African American, annual (/100,000)",
"White, annual (/100,000)",
"More than one race, annual (/100,000)"
))
) %>%
arrange(Metric) %>%
pivot_wider(names_from = period, values_from = Value)
# return both raw numeric + formatted
list(
outcome = outcome_name,
numeric_period_table = period_table,
publication_table = pub
)
}
# ---------------- Apply to your three datasets ----------------
# 1) ARF / Renal failure (N17)
arf_tbl <- make_period_table(
N17,
outcome_name = "ARF-related deaths (Renal failure)",
subchapter_filter = c("Renal failure")
)
# 2) Sepsis-related (A40)  (adjust filter if you use a different definition)
sepsis_tbl <- make_period_table(
A40,
outcome_name = "Sepsis-related deaths",
subchapter_filter = c("Other bacterial diseases")
)
# 3) Renal + Sepsis combined (N17A40)  (already combined; you can omit filter)
renal_sepsis_tbl <- make_period_table(
N17A40,
outcome_name = "Renal + Sepsis-related deaths"
)
# Use the publication-ready tables:
arf_tbl$publication_table
sepsis_tbl$publication_table
renal_sepsis_tbl$publication_table
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "ARF_year")
writeData(wb, "ARF_year", table_renal_year)
addWorksheet(wb, "sepsis_year")
writeData(wb, "sepsis_year", table_sepsis_year)
addWorksheet(wb, "ARF_sepsis_year")
writeData(wb, "ARF_sepsis_year", table_renal_sepsis_year)
addWorksheet(wb, "ARF_period_summary")
writeData(wb, "ARF_period_summary", arf_tbl$publication_table)
addWorksheet(wb, "Sepsis_period_summary")
writeData(wb, "Sepsis_period_summary", sepsis_tbl$publication_table)
addWorksheet(wb, "ARF_Sepsis_period_summary")
writeData(wb, "ARF_Sepsis_period_summary", renal_sepsis_tbl$publication_table)
addWorksheet(wb, "Deaths_by_age")
writeData(wb, "Deaths_by_age", deaths_table_age)
addWorksheet(wb, "Rate_by_age")
writeData(wb, "Rate_by_age", rate_table_age)
addWorksheet(wb, "Deaths_by_sex")
writeData(wb, "Deaths_by_sex", deaths_table_sex)
addWorksheet(wb, "Crude_rate_by_sex")
writeData(wb, "Crude_rate_by_sex", rate_table_sex)
addWorksheet(wb, "ARF_Sepsis_overlap_rates")
writeData(wb, "ARF_Sepsis_overlap_rates", overlap_table)
saveWorkbook(
wb,
file = "Supplementary_Tables_ARF_Sepsis_US_2010_2025.xlsx",
overwrite = TRUE
)
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "ARF_year")
writeData(wb, "ARF_year", table_renal_year)
addWorksheet(wb, "sepsis_year")
writeData(wb, "sepsis_year", table_sepsis_year)
addWorksheet(wb, "ARF_sepsis_year")
writeData(wb, "ARF_sepsis_year", table_renal_sepsis_year)
addWorksheet(wb, "ARF_period_summary")
writeData(wb, "ARF_period_summary", arf_tbl$publication_table)
addWorksheet(wb, "Sepsis_period_summary")
writeData(wb, "Sepsis_period_summary", sepsis_tbl$publication_table)
addWorksheet(wb, "ARF_Sepsis_period_summary")
writeData(wb, "ARF_Sepsis_period_summary", renal_sepsis_tbl$publication_table)
addWorksheet(wb, "Deaths_by_age")
writeData(wb, "Deaths_by_age", deaths_table_age)
addWorksheet(wb, "Rate_by_age")
writeData(wb, "Rate_by_age", rate_table_age)
addWorksheet(wb, "Deaths_by_sex")
writeData(wb, "Deaths_by_sex", deaths_table_sex)
addWorksheet(wb, "Crude_rate_by_sex")
writeData(wb, "Crude_rate_by_sex", rate_table_sex)
addWorksheet(wb, "ARF_Sepsis_overlap_rates")
writeData(wb, "ARF_Sepsis_overlap_rates", overlap_table)
saveWorkbook(
wb,
file = "Supplementary_Tables_ARF_Sepsis_US_2010_2025.xlsx",
overwrite = TRUE
)
