---
title: "code"
format: html
editor: visual
---
```{r}
library(readr)
library(tidyverse)
library(lubridate)
library(splines)
library(broom)
library(usmap)
library(scales)
N17_19 <- read_csv("N17-19.csv")
glimpse(N17_19)
```
## Map
```{r}
N17_19_clean <- N17_19 %>%
  filter(
    !is.na(State),
    !State %in% c("United States"),
    !is.na(`MCD - ICD Sub-Chapter Code`)
  ) %>%
  mutate(
    CrudeRate = as.numeric(`Crude Rate`)
  )

```

```{r}
yearly_df <- N17_19_clean %>%
  filter(!is.na(Year)) %>%
  select(
    state = `State`,
    year  = Year,
    rate  = CrudeRate
  )
```

```{r}
total_df <- N17_19_clean %>%
  filter(is.na(Year), Notes == "Total") %>%
  select(
    state = `State`,
    rate  = CrudeRate
  )

```

```{r}
plot_us_rate <- function(data, title) {
  plot_usmap(
    regions = "states",
    data    = data,
    values  = "rate",
    color   = "white"
  ) +
    scale_fill_gradient(
      low = "#e6f2ff",
    high = "#00468BFF",
      na.value = "grey90",
      labels = scales::number_format(accuracy = 0.1)
    ) +
    labs(
      title = title,
      fill  = "Deaths per\n100,000"
    ) +
    theme_minimal()
}


```

```{r}
yearly_df <- yearly_df %>%
  mutate(state = as.character(state))
```

```{r}
plot_usmap(
  regions = "states",
  data    = yearly_df,
  values  = "rate",
  color   = "white"
) +
  facet_wrap(~year) +
  scale_fill_gradient(
    low = "#e6f2ff",
    high = "#00468BFF",
    na.value = "grey90",
    labels = scales::number_format(accuracy = 0.1)
  ) +
  labs(
    title = "Renal Failure Mortality Rate (N17–N19) by Year",
    fill  = "Deaths per\n100,000"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

```
```{r}
plot_us_rate(
  total_df,
  "Renal Failure Mortality Rate (N17–N19)\nTotal Across Years"
)
```

```{r}
png(
  filename = "renal_failure_rate_2023.png",
  width = 10,
  height = 6,
  units = "in",
  res = 600
)

plot_us_rate(
  yearly_df %>% filter(year == 2023),
  "Renal Failure Mortality Rate (N17–N19), 2023"
)

dev.off()
```
```{r}
png(
  filename = "renal_failure_rate_2018_2023.png",
  width = 14,
  height = 8,
  units = "in",
  res = 600
)

plot_usmap(
  regions = "states",
  data    = yearly_df,
  values  = "rate",
  color   = "white"
) +
  facet_wrap(~year) +
  scale_fill_gradient(
    low = "#e6f2ff",
    high = "#0050b3",
    na.value = "grey90",
    labels = scales::number_format(accuracy = 0.1)
  ) +
  labs(
    title = "Renal Failure Mortality Rate (N17–N19) by Year",
    fill  = "Deaths per\n100,000"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

dev.off()

```
## Trend

```{r}
Trend <- read_csv("Trend.csv")
glimpse(Trend)
```
```{r}
library(tidyverse)
library(scales)


Trend_clean <- Trend %>%
  filter(!is.na(Year)) %>%                 # keep data rows only
  mutate(
    Year = as.integer(str_trim(as.character(Year))),
    code = str_trim(`Multiple Cause of death Code`),

    # convert "Unreliable" -> NA (as.numeric() will do this)
    age_adj = as.numeric(`Age Adjusted Rate`),

    # (optional) also clean crude rate if you want it later
    crude = as.numeric(`Crude Rate`)
  )

```

```{r}
pub_blue <- "#3b6ea5"   # muted, professional blue
pub_gray <- "#4d4d4d"

p2 <- ggplot(trend_age_top, aes(x = Year, y = age_adj)) +
  geom_line(linewidth = 1.0, color = "#4a4a4a") +
  geom_point(size = 2.0, color = "#4a4a4a") +
  facet_wrap(~code, scales = "free_y") +
  scale_x_continuous(breaks = sort(unique(trend_age_top$Year))) +
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1)) +
  labs(
    title = "Age-Adjusted Renal Failure Mortality Trends by ICD-10 Subcategory",
    subtitle = "United States, 2018–2023",
    x = NULL,
    y = "Deaths per 100,000 (age-adjusted)"
  ) +
  theme_classic(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(color = "grey30")
  )


```
```{r}
ggsave(
  "Age-Adjusted Renal Failure Mortality Trends.png",
  p2,
  width = 12,
  height = 6,
  units = "in",
  dpi = 600
)
```

```{r}
p_trend_faceted <- ggplot(trend_age_top, aes(x = Year, y = age_adj)) +

  # COVID-era shading
  annotate(
    "rect",
    xmin = 2019.5, xmax = 2021.5,
    ymin = -Inf, ymax = Inf,
    fill = "grey85", alpha = 0.4
  ) +

  geom_line(linewidth = 1.0, color = pub_blue) +
  geom_point(size = 2.0, color = pub_blue) +

  facet_wrap(~code, scales = "free_y") +

  scale_x_continuous(
    breaks = sort(unique(trend_age_top$Year))
  ) +
  scale_y_continuous(
    labels = number_format(accuracy = 0.1)
  ) +

  labs(
    title = "Renal Failure Mortality Trends by ICD-10 Subcategory",
    subtitle = "Age-adjusted to the 2000 U.S. standard population",
    x = NULL,
    y = "Age-adjusted deaths per 100,000"
  ) +

  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(color = pub_gray),
    strip.text = element_text(face = "bold"),
    axis.text = element_text(color = pub_gray),
    axis.title = element_text(color = pub_gray),
    panel.grid.minor = element_blank()
  )

p_trend_faceted
```
```{r}
p_overall <- ggplot(trend_total, aes(x = Year, y = crude_rate)) +

  annotate(
    "rect",
    xmin = 2019.5, xmax = 2021.5,
    ymin = -Inf, ymax = Inf,
    fill = "grey85", alpha = 0.4
  ) +

  geom_line(linewidth = 1.1, color = pub_blue) +
  geom_point(size = 2.2, color = pub_blue) +

  scale_x_continuous(breaks = sort(unique(trend_total$Year))) +
  scale_y_continuous(labels = number_format(accuracy = 0.1)) +

  labs(
    title = "Overall Renal Failure Mortality (N17–N19)",
    subtitle = "Crude deaths per 100,000",
    x = NULL,
    y = "Deaths per 100,000"
  ) +

  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(color = pub_gray),
    panel.grid.minor = element_blank()
  )

```
```{r}
library(patchwork)

final_figure <-
  p_overall /
  p_trend_faceted +
  plot_annotation(
    tag_levels = "A"
  )

final_figure

```
```{r}
ggsave(
  "renal_failure_trends_covid_panels.png",
  final_figure,
  width = 12,
  height = 10,
  units = "in",
  dpi = 600
)
```

```{r}
trend_overlay <- Trend %>%
  filter(!is.na(Year)) %>%
  mutate(
    Year = as.integer(str_trim(as.character(Year))),
    code = str_trim(`Multiple Cause of death Code`),
    age_adj = as.numeric(`Age Adjusted Rate`)   # "Unreliable" -> NA
  ) %>%
  filter(code %in% top_codes) %>%
  filter(!is.na(age_adj))
```

```{r}
# Okabe–Ito (colorblind-safe, publication common)
okabe_ito <- c(
  "N17.9" = "#0072B2",
  "N18.3" = "#009E73",
  "N18.5" = "#D55E00",
  "N18.9" = "#CC79A7",
  "N19"   = "#56B4E9"
)

# label positions at the last year for each code
end_labels <- trend_overlay %>%
  group_by(code) %>%
  filter(Year == max(Year)) %>%
  ungroup()

ggplot(trend_overlay, aes(x = Year, y = age_adj, color = code)) +
  geom_line(linewidth = 1.05) +
  geom_point(size = 2.0) +
  ggrepel::geom_text_repel(
    data = end_labels,
    aes(label = code),
    nudge_x = 0.25,
    direction = "y",
    hjust = 0,
    size = 3.2,
    segment.size = 0.3,
    show.legend = FALSE
  ) +
  scale_color_manual(values = okabe_ito) +
  scale_x_continuous(
    breaks = sort(unique(trend_overlay$Year)),
    expand = expansion(mult = c(0.01, 0.10))   # space on right for labels
  ) +
  scale_y_continuous(labels = number_format(accuracy = 0.1)) +
  labs(
    title = "Age-Adjusted Renal Failure Mortality by ICD-10 Subcategory (Multiple Cause)",
    subtitle = "United States, 2018–2023; age-adjusted to the 2000 U.S. standard population (per 100,000)",
    x = NULL,
    y = "Age-adjusted deaths per 100,000"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(color = "grey30"),
    axis.text = element_text(color = "grey20"),
    axis.title = element_text(color = "grey20"),
    panel.grid.minor = element_blank(),
    legend.position = "none"   # direct labels replace legend
  )

```

```{r}
ggsave(
  "age_adjusted_overlay_top_codes.png",
  width = 8.5, height = 5.5, units = "in", dpi = 600
)
```

