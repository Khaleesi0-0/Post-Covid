---
title: "Map"
format: html
editor: visual
---
```{r}
library(readr)
library(tidyverse)
library(lubridate)
library(splines)
library(broom)
library(usmap)
library(scales)
library(ggplot2)
library(sf)
library(tigris)
library(dplyr)
library(tidyr)
```

## Join

```{r}
stateN172010 <- read_csv("Data/stateN172010.csv")
stateN172018 <- read_csv("Data/stateN172018.csv")
clean_year <- function(df) {
  df %>%
    mutate(
      Year_raw = as.character(Year),
      # pull the first 4-digit year (e.g., "2024 (provisional)" -> 2024)
      Year = readr::parse_number(Year_raw),
      # keep any extra text as a note (optional)
      Year_note = str_squish(str_remove(Year_raw, "^\\d{4}"))
    )
}

N17 <- bind_rows(
  clean_year(stateN172010),
  clean_year(stateN172018)
) %>%
  select(-Year_raw)
```
```{r}
stateA402010 <- read_csv("Data/stateA402010.csv")
stateA402018 <- read_csv("Data/stateA402018.csv")

A40 <- bind_rows(
  clean_year(stateA402010),
  clean_year(stateA402018)
) %>%
  select(-Year_raw)
```

```{r}
stateN17A402010 <- read_csv("Data/stateN17A402010.csv")
stateN17A402018 <- read_csv("Data/stateN17A402018.csv")

N17A40 <- bind_rows(
  clean_year(stateN17A402010),
  clean_year(stateN17A402018)
) %>%
  select(-Year_raw)
```

## Map
```{r}
options(tigris_use_cache = TRUE)
```

```{r}
std2000_25plus <- tibble::tibble(
  age_code   = c("25-34", "35-44", "45-54", "55-64", "65-74", "75-84", "85+"),
  std_million = c(135573, 162613, 134834, 87247, 66037, 44842, 15508)
) %>%
  mutate(weight = std_million / sum(std_million))  # normalize within 25–85+
```

```{r}
period_map <- tibble::tibble(
  period_id = 1:4,
  period = c("Pre-pandemic (2010–2019)",
             "Pandemic (2020–2022)",
             "Transition (2023)",
             "Post-pandemic (2024–2025)"),
  year_start = c(2010, 2020, 2023, 2024),
  year_end   = c(2019, 2022, 2023, 2025)
)

add_period4 <- function(x) {
  x %>%
    left_join(period_map, join_by(Year >= year_start, Year <= year_end)) %>%
    filter(!is.na(period)) %>%
    mutate(period = factor(period, levels = period_map$period))
}

```

```{r}
calc_state_period_aamr <- function(df, outcome_label, subchapter_filter = NULL) {

  x <- df %>%
    dplyr::filter(is.na(Notes) | Notes != "Total",
                  Year >= 2010, Year <= 2025) %>%
    dplyr::mutate(
      State_use = dplyr::coalesce(State, `Residence State`)
    ) %>%
    dplyr::filter(!is.na(State_use), State_use != "United States")

  if (!is.null(subchapter_filter)) {
    x <- x %>% dplyr::filter(`MCD - ICD Sub-Chapter` %in% subchapter_filter)
  }

  x %>%
    dplyr::mutate(age_code = `Ten-Year Age Groups Code`) %>%
    dplyr::filter(age_code %in% std2000_25plus$age_code) %>%
    add_period4() %>%
    dplyr::group_by(State_use, period, age_code) %>%
    dplyr::summarise(
      deaths = sum(Deaths, na.rm = TRUE),
      pop    = sum(Population, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    dplyr::left_join(std2000_25plus, by = "age_code") %>%
    dplyr::mutate(age_rate = dplyr::if_else(pop > 0, (deaths / pop) * 1e5, NA_real_)) %>%
    dplyr::group_by(State_use, period) %>%
    dplyr::summarise(AAMR = sum(age_rate * weight, na.rm = TRUE), .groups = "drop") %>%
    dplyr::rename(State = State_use) %>%
    dplyr::mutate(outcome = outcome_label)
}
```

```{r}
state_period_aamr <- dplyr::bind_rows(
  calc_state_period_aamr(N17, "ARF", subchapter_filter = "Renal failure"),
  calc_state_period_aamr(A40, "Sepsis", subchapter_filter = "Other bacterial diseases"),
  calc_state_period_aamr(N17A40, "ARF & sepsis",subchapter_filter = "Renal failure")
) %>%
  dplyr::mutate(
    outcome = factor(outcome, levels = c("ARF", "Sepsis", "ARF & sepsis"))
  )

# Should be 0 after fix
sum(is.na(state_period_aamr$State))

# See which states are missing by period/outcome (if any)
state_period_aamr %>%
  count(outcome, period) %>%
  arrange(outcome, period)

```

```{r}
# Convert State name -> state abbreviation (needed for usmap)
# Get fips_info as a data frame (works whether it's an object or a function)
fi <- usmap::fips_info
if (is.function(fi)) fi <- usmap::fips_info()

state_period_aamr_usmap <- state_period_aamr %>%
  dplyr::left_join(
    fi %>% dplyr::select(full, abbr),
    by = c("State" = "full")
  ) %>%
  dplyr::rename(state = abbr) %>%
  dplyr::select(state, period, outcome, AAMR)



```

```{r}
make_outcome_map <- function(df, outcome_name, low_col, high_col) {

  df_out  <- df %>% filter(outcome == outcome_name)
  max_out <- max(df_out$AAMR, na.rm = TRUE)

  plot_usmap(
    regions = "states",
    data    = df_out,
    values  = "AAMR",
    color   = "grey60",
    size    = 0.2
  ) +
    facet_grid(period ~ .) +
    scale_fill_gradient(
      low      = low_col,
      high     = high_col,
      limits   = c(0, max_out),
      oob      = scales::squish,
      breaks   = pretty(c(0, max_out), n = 5),
      labels   = scales::number_format(accuracy = 1),
      na.value = "grey90"
    ) +
    guides(
      fill = guide_colorbar(
        title.position = "top",
        title.hjust    = 0.5,
        barwidth       = unit(6, "cm"),
        barheight      = unit(0.6, "cm")
      )
    ) +
    labs(
      title = paste0("AAMR: ", outcome_name),
      subtitle = paste0("Scale: 0–", round(max_out, 0), " per 100,000"),
      fill  = "AAMR"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title    = element_text(face = "bold", color = high_col),
      plot.subtitle = element_text(color = "grey30"),
      strip.text    = element_text(face = "bold", color = high_col),
      legend.position = "bottom",
      legend.title   = element_text(face = "bold"),
      panel.grid     = element_blank()
    )
}

```

```{r}
map_arf <- make_outcome_map(
  state_period_aamr_usmap,
  outcome_name = "ARF",
  low_col  = "#f7fbff",
  high_col = "#08306b"
)

map_sepsis <- make_outcome_map(
  state_period_aamr_usmap,
  outcome_name = "Sepsis",
  low_col  = "#f2f0f7",
  high_col = "#54278f"
)
map_arf_sepsis <- make_outcome_map(
  state_period_aamr_usmap,
  outcome_name = "ARF & sepsis",
  low_col  = "#f2e5ff",
  high_col = "#54278f"
)

map_arf
map_sepsis
map_arf_sepsis


```
```{r}
library(ggplot2)
library(patchwork)

combined_plot <-
  (map_arf | map_sepsis | map_arf_sepsis) +
  plot_annotation(
    title = "Age-Adjusted Mortality Rate by Outcome and Pandemic Period",
    theme = ggplot2::theme(
      plot.title = ggplot2::element_text(
        face = "bold",
        size = 14,
        hjust = 0.5
      )
    )
  )

ggsave(
  filename = "AAMR_maps_ARF_Sepsis_combined.png",
  plot     = combined_plot,
  width    = 14,      # inches (3 panels side by side)
  height   = 8,
  dpi      = 300,
  bg       = "white"
)
```

```{r}
ggsave(
  filename = "Figure_SX_US_State_AAMR_ARF_Sepsis_2010_2025.png",
  plot     = map_plot,
  width    = 20,
  height   = 8,
  dpi      = 600
)
```



## Bar graph

```{r}
library(ggplot2)
library(dplyr)
library(forcats)


rank_df <- state_period_aamr %>%
  filter(!is.na(State)) %>%
  mutate(
    outcome = factor(outcome, levels = c("ARF", "Sepsis", "ARF & sepsis")),
    period  = factor(
      period,
      levels = c(
        "Pre-pandemic (2010–2019)",
        "Pandemic (2020–2022)",
        "Transition (2023)",
        "Post-pandemic (2024–2025)"
      )
    )
  )



```


```{r}
p_ranked <- ggplot(
  rank_df,
  aes(
    x = fct_reorder(State, AAMR),
    y = AAMR
  )
) +
  geom_col(
    fill = "#00468BFF",
    width = 0.75
  ) +
  coord_flip() +
  facet_grid(outcome ~ period, scales = "free_y") +
  labs(
    title = "Ranked age-adjusted mortality rates (AAMR, ages 25–85+)",
    subtitle = "U.S. states by outcome and pandemic period",
    x = NULL,
    y = "AAMR per 100,000 population"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(face = "bold"),
    axis.text.y = element_text(size = 7),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )

p_ranked

```
```{r}
national_means <- rank_df %>%
  group_by(outcome, period) %>%
  summarise(mean_aamr = mean(AAMR, na.rm = TRUE), .groups = "drop")

p_ranked_cap <- p_ranked +
  geom_hline(
    data = national_means,
    aes(yintercept = mean_aamr),
    linetype = "dashed",
    color = "grey40",
    linewidth = 0.4
  ) +
  labs(
    caption = "Dashed horizontal lines indicate the national mean age-adjusted mortality rate (AAMR) for each outcome and pandemic period."
  )

p_ranked_cap
```
```{r}
ggsave(
  "Ranked_AAMR_State_BarCharts_All_Outcomes_Periods.png",
  p_ranked_cap,
  width = 20,
  height = 15,
  dpi = 600
)
```

## Table

```{r}
library(dplyr)
library(tidyr)

# Ensure consistent factor order
period_levels <- c(
  "Pre-pandemic (2010–2019)",
  "Pandemic (2020–2022)",
  "Transition (2023)",
  "Post-pandemic (2024–2025)"
)

outcome_levels <- c("ARF", "Sepsis", "ARF & sepsis")

# All 50 states (+ DC if you want)
fi <- usmap::fips_info
if (is.function(fi)) fi <- usmap::fips_info()

all_states <- fi$full %>%
  unique() %>%
  setdiff(c("District of Columbia"))  # remove DC; delete this line if you want DC included

state_aamr_table <- state_period_aamr %>%
  filter(!is.na(State), State %in% all_states) %>%
  mutate(
    period  = factor(period, levels = period_levels),
    outcome = factor(outcome, levels = outcome_levels)
  ) %>%
  # complete grid so every State has every period × outcome (AAMR may be NA)
  complete(
    State = all_states,
    period = factor(period_levels, levels = period_levels),
    outcome = factor(outcome_levels, levels = outcome_levels)
  ) %>%
  # make column names like: ARF_Pre, Sepsis_Pandemic, etc.
  mutate(
    period_short = recode(as.character(period),
      "Pre-pandemic (2010–2019)"  = "Pre",
      "Pandemic (2020–2022)"      = "Pandemic",
      "Transition (2023)"         = "Transition",
      "Post-pandemic (2024–2025)" = "Post"
    ),
    col = paste0(outcome, "_", period_short)
  ) %>%
  select(State, col, AAMR) %>%
  pivot_wider(names_from = col, values_from = AAMR) %>%
  arrange(State)

```

```{r}
state_aamr_table_pub <- state_aamr_table %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))

state_aamr_table_pub

```

```{r}
library(openxlsx)

wb <- createWorkbook()
addWorksheet(wb, "State_AAMR_Periods")
writeData(wb, "State_AAMR_Periods", state_aamr_table_pub)
saveWorkbook(wb, "State_AAMR_Periods_Table.xlsx", overwrite = TRUE)

```


```{r}
library(officer)
library(flextable)
library(dplyr)

# helper to build a readable flextable (no set_repeat_header)
make_ft <- function(df, font_size = 9) {
  flextable(df) |>
    theme_booktabs() |>
    fontsize(size = font_size, part = "all") |>
    padding(padding = 2, part = "all") |>
    autofit() |>
    align(align = "center", part = "all") |>
    align(j = 1, align = "left", part = "all")
}

# Check your real column names first (optional)
# names(state_aamr_table_pub)

# If your columns are ARF_Pre, ARF_Pandemic, ARF_Transition, ARF_Post:
arf_tbl <- state_aamr_table_pub %>%
  dplyr::select(dplyr::any_of(c("State","ARF_Pre","ARF_Pandemic","ARF_Transition","ARF_Post")))

sep_tbl <- state_aamr_table_pub %>%
  dplyr::select(dplyr::any_of(c("State","Sepsis_Pre","Sepsis_Pandemic","Sepsis_Transition","Sepsis_Post")))

both_tbl <- state_aamr_table_pub %>%
  dplyr::select(dplyr::any_of(c("State","ARF & sepsis_Pre","ARF & sepsis_Pandemic","ARF & sepsis_Transition","ARF & sepsis_Post")))

doc <- read_docx()

doc <- body_add_par(doc,
  "State-level AAMRs by outcome and pandemic period (2010–2025)",
  style = "heading 1"
)

doc <- body_add_par(doc,
  "Values are age-adjusted mortality rates (AAMR) per 100,000 for ages 25–85+, standardized to the 2000 U.S. standard population.",
  style = "Normal"
)

doc <- body_add_par(doc, "ARF (Renal failure)", style = "heading 2")
doc <- body_add_flextable(doc, make_ft(arf_tbl, font_size = 9))
doc <- body_add_break(doc)

doc <- body_add_par(doc, "Sepsis", style = "heading 2")
doc <- body_add_flextable(doc, make_ft(sep_tbl, font_size = 9))
doc <- body_add_break(doc)

doc <- body_add_par(doc, "ARF & Sepsis", style = "heading 2")
doc <- body_add_flextable(doc, make_ft(both_tbl, font_size = 9))

print(doc, target = "State_AAMR_Periods_Tables_Portrait.docx")



```

